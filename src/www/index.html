<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
          name="viewport" />
    <link rel="icon"
          href="/favicon.png"
          type="image/png" />
    <link href="/css/bootstrap.min.css"
          rel="stylesheet"
          type="text/css" />
    <link href="/css/bootstrap-theme.min.css"
          rel="stylesheet"
          type="text/css" />
    <link href="/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css" />
    <script src="/js/promise.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/fetch.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/jquery.min.js"
            type="text/javascript">
    </script>
    <script src="/js/bootstrap.min.js"
            type="text/javascript"
            async defer>
    </script>
    <title>CosyVerif</title>
  </head>
  <body>
    <div id="headbar"></div>
    <div class="container-fluid main-content">
      <div class="row">
        <div id="main"></div>
      </div>
    </div>

    <script type="text/lua"
            lang="Lua">
      -- Taken from lua.vm.js:
      local function load_lua_over_http (url)
      	local xhr = _G.js.new (_G.window.XMLHttpRequest)
      	xhr:open ("GET", url, false)
      	local ok, err = pcall (xhr.send, xhr)
      	if not ok then
      		return nil, tostring (err)
      	elseif xhr.status ~= 200 then
      		return nil, "HTTP GET " .. xhr.statusText .. ": " .. url
      	end
      	return load (xhr.responseText, url)
      end
      package.searchers [#package.searchers] = nil
      package.searchers [#package.searchers] = nil
      table.insert (package.searchers, function (mod_name)
      	if not mod_name:match("/") then
      		local full_url = "/lua/" .. mod_name
      		local func, err = load_lua_over_http (full_url)
      		if func ~= nil then return func end
      		return "\n    " .. err
      	end
      end)
      xpcall (function ()
        local Coromake = require "coroutine.make"
        local co = coroutine.create (function ()
          local Adapter = require "cosy.webclient.adapter"
          local Copas   = require "copas"
          local Http    = require "cosy.webclient.http"
          local Client  = require "cosy.client"
          local info    = Http.json {
            url = "/info",
          }
          Adapter.client = Client.new {
            url   = info.api_url,
            token = nil,
          }
          local Test    = require "cosy.webclient.test"
          Copas.loop ()
        end)
        assert (coroutine.resume (co))
      end, function (err)
        print ("error:", err)
        print (debug.traceback ())
      end)
    </script>

    <script src="/js/locationpicker.jquery.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/bootbox.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/lua.vm.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=places"
            type="text/javascript"
            async defer>
    </script>
    <script src="https://www.google.com/recaptcha/api.js?render=explicit"
            type="text/javascript"
            async defer>
    </script>
  </body>
</html>
