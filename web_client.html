<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>CosiVerif Beta Client</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Styles -->
        <link href="lua_vm/css/bootstrap.css" rel="stylesheet">
        <link href="lua_vm/css/bootstrap-responsive.css" rel="stylesheet">
        
        <!-- Model Graph styles-->      
        <link rel="stylesheet" type="text/css" href="css/model_gui.css">
        <link rel="stylesheet" type="text/css" href="css/web_client.css">
        
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
          <script src="js/html5shiv.js"></script>
        <![endif]-->

        <!-- Codemirror styles -->
        <link rel="stylesheet" href="lua_vm/css/codemirror.css">
        
        
        <!-- We include all the js we need-->
        <script src="lua_vm/js/codemirror.js"></script>
        <script src="lua/js.lua" type="text/lua"></script>
        <script src="lua_vm/js/lua.js"></script>
        <script type="text/javascript" src="d3/d3.js"></script>
    </head>
    
    <body onLoad="init()">
        <div class="container">
            <div class="page-header">
                <h1>CosyVerif WebClient<small> A graphical representation of Lua Models</small></h1> 
            </div>
            <div class="row">
                <div class="span7" border=1>
                    <h4>Lua Code</h4>
                    <input type="file" id="file_browser">
                    <textarea id="model_code"></textarea>
                </div>
                <div class="span5">
                    <h4>Lua Code Output</h4>
                    <pre id="output">In here we can watch any output of the lua code. Also, any exception during execution time will be posted here</pre>
                </div>
            </div>
            <a href="#" class="btn btn-primary" onclick="executeLua(lua_code.getValue(), true); return false" id="the_button">Execute Lua Code &raquo;</a>
            <a href="#" class="btn btn-danger" onclick="" id="simulation_btn">Run Simulation &raquo;</a>
            
            <div class="row voffset4">
            </div>
            
            <ul id="tabs">
                <li><a href="#model_gui">Model Graph</a></li>
                <li><a href="#model_patches">Patches</a></li>
            </ul>
            <div class="tabContent" id="model_gui">
                <h4>Lua Model</h4>
                <div id="model_container" class="span7">
                </div>
            </div>
            <div class="tabContent" id="model_patches">
                <h3>Server Patches</h3>
                <textarea id="server_patches" width="200" height="150"></textarea>
            </div>
        </div> <!-- /container -->
        
        <script type="text/javascript" languaj="Javascript" src="model_gui.js"></script>
        
        <script type="text/javascript" languaje="Javascript">
            // CodeMirror
            var lua_code = CodeMirror.fromTextArea(document.getElementById('model_code'),{
                lineNumbers: true,
            });
            
            var server_patches = CodeMirror.fromTextArea(document.getElementById('server_patches'),{
                lineNumbers: true,
                readOnly: true
            });
            server_patches.setValue("local p = { a = {b = 21}, c = {}};");
            
            // Tabs                    
            var tabLinks = new Array();
            var contentDivs = new Array();
            
            function init() {
                // Grab the tab links and content divs from the page
                var tabListItems = document.getElementById('tabs').childNodes;
                for (var i = 0; i < tabListItems.length; i++) {
                    if ( tabListItems[i].nodeName == "LI" ) {
                          var tabLink = getFirstChildWithTagName( tabListItems[i], 'A' );
                          var id = getHash( tabLink.getAttribute('href') );
                          tabLinks[id] = tabLink;
                          contentDivs[id] = document.getElementById( id );
                        }
                }

                // Assign onclick events to the tab links, and
                // highlight the first tab
                var i = 0;
                for ( var id in tabLinks ) {
                    tabLinks[id].onclick = showTab;
                    tabLinks[id].onfocus = function() { this.blur() };
                    if ( i == 0 ) tabLinks[id].className = 'selected';
                    i++;
                }

                // Hide all content divs except the first
                var i = 0;
                for ( var id in contentDivs ) {
                    if ( i != 0 ) contentDivs[id].className = 'tabContent hide';
                    i++;
                }
            }
            
            function showTab() {
                var selectedId = getHash( this.getAttribute('href') );
                
                // Highlight the selected tab, and dim all others.
                // Also show the selected content div, and hide all others.
                for ( var id in contentDivs ) {
                    if ( id == selectedId ) {
                        tabLinks[id].className = 'selected';
                        contentDivs[id].className = 'tabContent';
                    } else {
                        tabLinks[id].className = '';
                        contentDivs[id].className = 'tabContent hide';
                    }
                }
                // Stop the browser following the link
                return false;
            }
            
            function getFirstChildWithTagName( element, tagName ) {
                for ( var i = 0; i < element.childNodes.length; i++ ) {
                    if ( element.childNodes[i].nodeName == tagName ) return element.childNodes[i];
                }
            }
            
            function getHash( url ) {
                var hashPos = url.lastIndexOf ( '#' );
                return url.substring( hashPos + 1 );
            }
            
            
            // Execution
            var outputElement = document.getElementById('output');
            var Module = {
                print: function(x) {
                    console.log(""+x);
                    outputElement.innerHTML = (outputElement.innerHTML ? outputElement.innerHTML + '<br>' : '') + x;
                }
            };

            // File Reader
            document.getElementById('file_browser').addEventListener('change', CopyMe, false);
            
            function CopyMe(evt) {
                var file = evt.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(){ lua_code.setValue(reader.result); }
                    reader.readAsText(file);
                }
            };
            
            function executeLua(code, clear) {
                if (clear) outputElement.innerHTML = '';
                
                var js_declarations = ' local keys = {}; \
                                    for k in pairs(model) \
                                    do \
                                    keys[#keys+1] = k; \
                                    end \
                                    local window    = js.global; \
                                    window.model    = model; \
                                    window.keys     = keys; \
                                    window.count    = #keys; \
                                    window.var_type = type; \
                                    window.type_place      = place; \
                                    window.type_transition = transition; \
                                    window.type_arc        = arc;';
                
                try {
                    L.execute(code + js_declarations);
                    //~ L.execute(code);
                } catch(err) {
                        Module.print('ERROR: ' + err);
                        throw(err);
                }
                
                updateModel();
            }
            
        </script>
        <script type="text/javascript" lang="Javascript" src="lua_vm/lua.vm.js"></script>
    </body>
</html>

`
